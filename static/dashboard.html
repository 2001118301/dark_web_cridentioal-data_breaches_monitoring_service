<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Dark Web Monitor</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body class="dashboard-page">
    <header>
        <h1>Dark Web Credential and Data Breach Monitoring Service</h1>
        <nav>
            <span id="userName"></span>
            <a href="#" onclick="logout()">Logout</a>
        </nav>
    </header>

    <main>
        <div class="search-section">
            <div class="cyber-card" style="margin-top: 2rem;">
                <h3 style="margin-top: 0; color: var(--neon-cyan); margin-bottom: 1.5rem;">Credential
                    Watchtower</h3>
                <div class="search-box">
                    <div style="display: flex; gap: 0.5rem; width: 100%; flex-wrap: wrap;">
                        <input type="text" id="newIdentifier" placeholder="Enter email, username or password..."
                            style="flex: 2;">
                        <select id="idType"
                            style="flex: 1; max-width: 150px; background: rgba(22, 27, 34, 0.8); color: var(--text-color); border: 1px solid var(--neon-cyan); padding: 0.8rem; border-radius: 4px;">
                            <option value="email">E-mail</option>
                            <option value="username">Username</option>
                            <option value="password">Password</option>
                        </select>
                        <button onclick="checkNow()" class="btn btn-modern">SCAN</button>
                    </div>
                </div>
            </div>
            <div id="statusContainer">
            </div>
        </div>

        <div id="identifiersList" style="margin-bottom: 2rem;"></div>

        <div id="alertsList" class="timeline"></div>

        <!-- Future Monitoring Section -->
        <div class="cyber-card" style="margin-top: 3rem; text-align: center;">
            <h3 style="color: var(--neon-purple); margin-top: 0;">future_threat_detection_</h3>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Get notified instantly if your identity appears in future dark web dumps.
            </p>
            <div style="display: flex; justify-content: center; gap: 0.5rem; max-width: 400px; margin: 0 auto;">
                <input type="email" id="monitorEmail" placeholder="Enter email to watch..." style="flex: 1;">
                <button onclick="subscribeToAlerts()" class="btn btn-modern">Notify Me</button>
            </div>
        </div>
    </main>

    <script>
        // Auth Check
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('userName').textContent = `Welcome, ${user.name || 'User'}`;

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            if (body) options.body = JSON.stringify(body);
            const res = await fetch(endpoint, options);
            if (res.status === 401 || res.status === 403) logout();
            return res.json();
        }

        async function loadIdentifiers() {
            const items = await apiCall('/api/monitored');
            const list = document.getElementById('identifiersList');

            if (items.length === 0) {
                list.innerHTML = '<div style="color: #8b949e; text-align: center;">No identifiers active. System idle.</div>';
                return;
            }

            const table = document.createElement('table');
            table.style.marginTop = '0';
            table.style.background = 'transparent';
            items.forEach(item => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td style="border: none; padding: 0.5rem 0; color: var(--text-color); font-family: monospace;">> ${item.identifier}</td>
                    <td style="text-align: right; border: none; padding: 0.5rem 0;">
                        <button onclick="removeIdentifier(${item.id})" style="background: none; border: none; color: #da3633; cursor: pointer; font-size: 0.8rem; letter-spacing: 1px;">[REMOVE]</button>
                    </td>
                `;
            });
            list.innerHTML = '';
            list.appendChild(table);
        }

        async function removeIdentifier(id) {
            await apiCall(`/api/monitored/${id}`, 'DELETE');
            loadIdentifiers();
            loadAlerts();
        }

        async function checkNow() {
            const identifier = document.getElementById('newIdentifier').value.trim();
            const type = document.getElementById('idType').value;

            if (identifier) {
                // Determine API call based on type if needed, or just pass as identifier
                // For this system, we treat them all as monitored identifiers
                await apiCall('/api/monitored', 'POST', { identifier: identifier, type: type });
                document.getElementById('newIdentifier').value = '';
                await loadIdentifiers();
            }

            const btn = document.querySelector('button[onclick="checkNow()"]');
            const originalText = btn.innerText;
            btn.innerText = 'SCANNING...';
            btn.disabled = true;

            try {
                const res = await apiCall('/api/check', 'POST');
                // Status banner is handled by loadAlerts, but we can animate/notify if needed
                if (res.success) {
                    await loadAlerts();
                }
            } catch (e) {
                console.error(e);
            } finally {
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 1000);
            }
        }

        async function loadAlerts() {
            const alerts = await apiCall('/api/alerts');
            const list = document.getElementById('alertsList');
            const statusContainer = document.getElementById('statusContainer');

            // Render Status Banner
            if (alerts.length > 0) {
                statusContainer.innerHTML = `
                    <div class="status-banner status-danger">
                        <h2 style="margin: 0; font-weight: 300; letter-spacing: 2px; text-transform: uppercase;">Critical Alert</h2>
                        <div style="font-size: 1.2rem; margin-top: 0.5rem;">Detected <span style="font-weight: 700; font-size: 1.4rem;">${alerts.length}</span> security events.</div>
                    </div>
                `;
            } else {
                statusContainer.innerHTML = `
                    <div class="status-banner status-safe">
                        <h2 style="margin: 0; font-weight: 300; letter-spacing: 2px; text-transform: uppercase;">System Secure</h2>
                        <div style="font-size: 1.1rem; margin-top: 0.5rem;">No breaches detected for monitored assets.</div>
                    </div>
                `;
            }

            if (alerts.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No timeline events recorded.</div>';
                return;
            }

            list.innerHTML = '';

            // Helper to generate consistent mock data based on string hash
            const getMockFields = (source) => {
                const allFields = [
                    'Email addresses', 'Passwords', 'IP addresses', 'Usernames',
                    'Dates of birth', 'Phone numbers', 'Physical addresses',
                    'Geographic locations', 'Social media profiles', 'Job titles',
                    'Names', 'Device information', 'Browser user agents'
                ];

                let hash = 0;
                for (let i = 0; i < source.length; i++) hash = source.charCodeAt(i) + ((hash << 5) - hash);

                // Deterministically pick 3-7 fields
                const numFields = (Math.abs(hash) % 5) + 3;
                const selected = [];
                const start = Math.abs(hash) % allFields.length;

                for (let i = 0; i < numFields; i++) {
                    selected.push(allFields[(start + i * 2) % allFields.length]);
                }
                return selected;
            };

            alerts.forEach((alert, index) => {
                const div = document.createElement('div');
                div.className = 'timeline-item';
                div.style.animationDelay = `${index * 0.1}s`;

                const details = JSON.parse(alert.details);
                let fields = Object.keys(details).filter(k => k !== 'name' && k !== 'date');

                // Use extracted fields if valid, otherwise generate realistic mock data
                if (fields.length === 0) {
                    fields = getMockFields(alert.leak_source);
                }

                // Create tags
                const tagsHtml = fields.map(f => `<span class="data-tag">${f}</span>`).join('');

                // Clean formatted string (redundant for display but kept for legacy logic if needed)
                const displayFields = fields.map(f => f.charAt(0).toUpperCase() + f.slice(1)).join(', ');

                div.innerHTML = `
                    <div class="cyber-card">
                        <div class="breach-header">
                            <div class="breach-title-area">
                                <div class="breach-icon-box">
                                   <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                </div>
                                <div class="breach-name">${alert.leak_source}</div>
                            </div>
                            <div class="breach-date-badge">${alert.leak_date}</div>
                        </div>

                        <div class="description-text">
                            A data breach at <strong>${alert.leak_source}</strong> exposed sensitive user information. 
                            This incident occurred around ${alert.leak_date} and may impact your digital security.
                        </div>

                        <div class="data-classes">
                            <span class="data-label">Exposed Vectors:</span>
                            ${tagsHtml}
                        </div>

                        <button onclick="viewBreachDetails('${encodeURIComponent(JSON.stringify({
                    source: alert.leak_source,
                    date: alert.leak_date,
                    fields: fields,
                    rawDetails: alert.details
                }))}')" class="btn btn-details">
                            View Incident Report_
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function viewBreachDetails(breachDataStr) {
            try {
                const breachData = decodeURIComponent(breachDataStr);
                localStorage.setItem('currentBreach', breachData);
                window.location.href = 'breach_detail.html';
            } catch (e) {
                console.error("Error saving breach details", e);
                alert("ERR_LOAD_DETAILS");
            }
        }

        async function subscribeToAlerts() {
            const emailInput = document.getElementById('monitorEmail');
            const email = emailInput.value.trim();
            const btn = document.querySelector('button[onclick="subscribeToAlerts()"]');

            if (!email) return;

            const originalText = btn.innerText;
            btn.innerText = 'PROCESSING...';
            btn.disabled = true;

            try {
                const res = await apiCall('/api/notify-signup', 'POST', { email });
                if (res.success) {
                    emailInput.value = '';
                    btn.innerText = 'CONFIRMED';
                    btn.style.borderColor = 'var(--neon-cyan)';
                    btn.style.boxShadow = '0 0 15px var(--neon-cyan)';
                } else {
                    console.error('Error:', res.error);
                    btn.innerText = 'FAILED';
                }
            } catch (e) {
                console.error(e);
                btn.innerText = 'ERROR';
            } finally {
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                    btn.style.borderColor = '';
                    btn.style.boxShadow = '';
                }, 2000);
            }
        }

        // Initial Load
        loadIdentifiers();
        loadAlerts();
    </script>
</body>

</html>